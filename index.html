<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MIS Budget System 2569</title>

  <!-- React 18 CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  
  <!-- SheetJS for Excel Export -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --primary:#a72c32;
      --secondary:#1e1e1e;
      --accent:#de3e46;
      --bg:#f8fafc;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --card:#ffffff;
      --soft:#f1f5f9;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    button{ font-family:inherit; }
    
    /* Login Page Styles */
    .loginContainer{
      min-height:100vh; display:grid; place-items:center; padding:20px;
      background:linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    }
    .loginCard{
      background:#fff; border-radius:28px; padding:40px;
      box-shadow:0 20px 60px rgba(0,0,0,.3);
      width:100%; max-width:420px;
    }
    .loginLogo{
      width:64px; height:64px; border-radius:20px; background:var(--primary);
      display:grid; place-items:center; font-weight:900; font-size:32px;
      color:#fff; margin:0 auto 24px;
    }
    .loginTitle{ font-size:28px; font-weight:900; text-align:center; margin-bottom:8px; }
    .loginSubtitle{ text-align:center; color:var(--muted); font-weight:900; font-size:14px; margin-bottom:32px; }
    .loginForm{ display:grid; gap:20px; }
    .loginField{ display:grid; gap:8px; }
    .loginLabel{ font-size:12px; font-weight:900; color:var(--muted); text-transform:uppercase; }
    .loginInput{
      width:100%; padding:14px; border-radius:14px; border:2px solid var(--border);
      font-weight:800; font-size:15px; outline:none; transition:all .2s;
    }
    .loginInput:focus{ border-color:var(--primary); background:#fff; }
    .loginButton{
      width:100%; padding:16px; border-radius:14px; border:0;
      background:var(--primary); color:#fff; font-weight:900; font-size:16px;
      cursor:pointer; transition:all .2s;
    }
    .loginButton:hover{ background:var(--accent); transform:translateY(-2px); }
    .loginButton:active{ transform:translateY(0); }
    .demoAccounts{
      margin-top:24px; padding:16px; background:#f8fafc; border-radius:16px;
      border:1px dashed var(--border);
    }
    .demoTitle{ font-size:11px; font-weight:900; color:var(--muted); text-transform:uppercase; margin-bottom:12px; }
    .demoAccount{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px; background:#fff; border-radius:12px; margin-bottom:8px;
      cursor:pointer; transition:all .2s; border:1px solid var(--border);
    }
    .demoAccount:hover{ border-color:var(--primary); transform:translateX(4px); }
    .demoAccount:last-child{ margin-bottom:0; }
    .demoRole{ font-weight:900; font-size:13px; }
    .demoCredentials{ font-size:11px; color:var(--muted); font-weight:900; }
    .errorMsg{
      padding:12px; background:#fee2e2; color:#991b1b; border-radius:12px;
      font-weight:900; font-size:13px; text-align:center;
    }
    
    /* Main App Layout */
    .app{ display:flex; height:100vh; overflow:hidden; }
    .sidebar{
      width:280px; background:var(--secondary); color:#fff;
      padding:20px; display:flex; flex-direction:column;
      transition:transform .3s ease;
    }
    .brand{ display:flex; align-items:center; gap:10px; margin-bottom:18px; }
    .logo{ width:34px; height:34px; border-radius:12px; background:var(--primary); display:grid; place-items:center; font-weight:900; }
    .navbtn{
      width:100%; display:flex; align-items:center; gap:10px;
      padding:12px 14px; border-radius:14px; border:0; cursor:pointer;
      background:transparent; color:rgba(255,255,255,.75);
      font-weight:900; text-transform:uppercase; font-size:12px; letter-spacing:.5px;
      margin-bottom:8px; transition:all .2s;
    }
    .navbtn:hover{ background:rgba(255,255,255,.1); }
    .navbtn.active{ background:var(--primary); color:#fff; }
    .main{ flex:1; display:flex; flex-direction:column; min-width:0; }
    .header{
      height:64px; background:#fff; border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; padding:0 18px;
      flex-shrink:0;
    }
    .hamburger{
      display:none; width:40px; height:40px; border:0; background:var(--soft);
      border-radius:12px; cursor:pointer; font-size:20px; align-items:center;
      justify-content:center;
    }
    .content{ padding:18px; overflow:auto; flex:1; }
    .grid4{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:22px;
      padding:16px; box-shadow:0 8px 24px rgba(15,23,42,.06);
    }
    .cardTitle{ font-size:12px; font-weight:900; color:var(--muted); text-transform:uppercase; }
    .cardValue{ font-size:26px; font-weight:900; margin-top:6px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .half{ flex:1 1 420px; }
    .btnPrimary{
      background:var(--primary); color:#fff; border:0; padding:10px 14px;
      border-radius:14px; font-weight:900; cursor:pointer; transition:all .2s;
    }
    .btnPrimary:hover{ background:var(--accent); }
    .btnPrimary:disabled{ opacity:.5; cursor:not-allowed; }
    .btnSoft{
      background:var(--soft); color:#334155; border:1px solid var(--border);
      padding:10px 14px; border-radius:14px; font-weight:900; cursor:pointer; transition:all .2s;
    }
    .btnSoft:hover{ background:#e2e8f0; }
    .pill{ display:inline-block; padding:4px 10px; border-radius:999px; font-size:11px; font-weight:900; }
    .pill.gray{ background:#e2e8f0; color:#334155; }
    .pill.green{ background:#dcfce7; color:#166534; }
    .pill.yellow{ background:#fef9c3; color:#854d0e; }
    .pill.red{ background:#fee2e2; color:#991b1b; }
    .pill.blue{ background:#dbeafe; color:#1e40af; }
    table{ width:100%; border-collapse:collapse; }
    th{
      text-align:left; font-size:11px; color:var(--muted);
      text-transform:uppercase; letter-spacing:.6px; padding:12px;
      background:#f8fafc; border-bottom:1px solid var(--border);
    }
    td{ padding:12px; border-bottom:1px solid var(--border); font-size:13px; vertical-align:top; }
    .modalOverlay{
      position:fixed; inset:0; background:rgba(0,0,0,.75);
      display:grid; place-items:center; padding:16px; z-index:999;
    }
    .modal{
      width:min(1100px,96vw); max-height:92vh; background:#fff; border-radius:28px;
      overflow:hidden; display:flex; flex-direction:column;
    }
    .modalHead{
      padding:18px; background:#f8fafc; border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; flex-shrink:0;
    }
    .modalBody{ padding:18px; overflow:auto; }
    .label{ font-size:11px; font-weight:900; color:var(--muted); text-transform:uppercase; letter-spacing:.6px; margin-bottom:6px; }
    input, select, textarea{
      width:100%; padding:12px; border-radius:14px; border:1px solid var(--border);
      background:#f8fafc; font-weight:800; outline:none; font-size:14px;
    }
    textarea{ min-height:90px; resize:vertical; }
    .muted{ color:var(--muted); font-weight:900; font-size:12px; }
    .dividerL{ padding-left:12px; border-left:4px solid var(--border); }
    .danger{ color:#b91c1c; font-weight:900; display:flex; gap:6px; align-items:center; }
    .ellipsis{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .checkboxWrapper{ display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; border-radius:8px; }
    .checkboxWrapper:hover{ background:#f1f5f9; }
    .checkbox{ width:18px; height:18px; cursor:pointer; accent-color:var(--primary); }
    .selectionInfo{
      background:#eff6ff; border:1px solid #dbeafe; border-radius:16px; padding:12px;
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;
    }
    .userInfo{
      display:flex; align-items:center; gap:10px; padding:12px; background:rgba(255,255,255,.05);
      border-radius:12px; margin-bottom:10px;
    }
    .userAvatar{
      width:38px; height:38px; border-radius:999px; background:var(--primary);
      display:grid; place-items:center; font-weight:900; flex-shrink:0;
    }
    .roleBadge{
      padding:4px 8px; border-radius:8px; font-size:10px; font-weight:900;
      text-transform:uppercase; letter-spacing:.5px;
    }
    .roleBadge.admin{ background:#ef4444; color:#fff; }
    .roleBadge.user{ background:#3b82f6; color:#fff; }
    
    /* Responsive Design - Mobile First */
    @media (max-width: 768px) {
      .sidebar{
        position:fixed; left:0; top:0; bottom:0; z-index:1000;
        transform:translateX(-100%); width:280px;
      }
      .sidebar.open{ transform:translateX(0); box-shadow:4px 0 20px rgba(0,0,0,.3); }
      .hamburger{ display:flex !important; }
      .header{ padding:0 12px; }
      .content{ padding:12px; }
      .grid4{ grid-template-columns:1fr; }
      .row{ flex-direction:column; }
      .half{ flex:1 1 100%; }
      .card{ padding:14px; border-radius:18px; }
      .cardValue{ font-size:22px; }
      .loginCard{ padding:28px; }
      .modal{ width:100vw; height:100vh; max-height:100vh; border-radius:0; }
      .modalHead{ padding:14px; }
      .modalBody{ padding:14px; }
      table{ font-size:12px; }
      th, td{ padding:8px; }
      .selectionInfo{ flex-direction:column; align-items:stretch; }
      .btnPrimary, .btnSoft{ font-size:14px; padding:12px; }
    }
    
    @media (max-width: 480px) {
      .content{ padding:8px; }
      .card{ padding:12px; }
      .cardTitle{ font-size:10px; }
      .cardValue{ font-size:18px; }
      .loginCard{ padding:20px; }
      .loginTitle{ font-size:24px; }
      input, select, textarea{ font-size:16px; } /* Prevent zoom on iOS */
    }
    
    /* Tablet */
    @media (min-width: 769px) and (max-width: 1024px) {
      .sidebar{ width:240px; padding:16px; }
      .grid4{ grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); }
    }
    
    /* Overlay for mobile sidebar */
    .sidebarOverlay{
      display:none; position:fixed; inset:0; background:rgba(0,0,0,.5);
      z-index:999;
    }
    .sidebarOverlay.show{ display:block; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
  const { useMemo, useState, useCallback } = React;

  const THEME = { primary:"#a72c32", accent:"#de3e46" };

  const INITIAL_USERS = [
    { id:"U1", username:"admin", password:"123", name:"Admin Strategy", role:"admin" },
    { id:"U2", username:"user", password:"123", name:"User Viewer", role:"user" },
  ];

  const INITIAL_DATA = [
    {
      id:"PT1", name:"à¸žà¸±à¸™à¸˜à¸à¸´à¸ˆà¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸™à¸à¸²à¸£à¸ªà¸­à¸™", sapa_approved:21104500, rolling_2568:881276, progress:0,
      main_projects:[
        {
          id:"PT1-2569-001", name:"à¹‚à¸„à¸£à¸‡à¸à¸²à¸£à¸£à¸±à¸šà¸™à¸±à¸à¸¨à¸¶à¸à¸©à¸²à¹€à¸Šà¸´à¸‡à¸£à¸¸à¸à¸£à¸°à¸”à¸±à¸šà¸£à¸°à¸”à¸±à¸šà¸›à¸£à¸´à¸à¸à¸²à¸•à¸£à¸µ", fiscal_year:"2569", responsible:"à¸„à¸¸à¸“à¸›à¸—à¸´à¸•à¸•à¸²",
          sapa_approved:2310000, rolling:0, proposed_budget:2370000,
          q1_plan:0,q2_plan:0,q3_plan:0,q4_plan:0, actual_spent:0,
          progress:0, problem:"",
          sub_projects:[]
        }
      ]
    },
    {
      id:"PT2", name:"à¸žà¸±à¸™à¸˜à¸à¸´à¸ˆà¸§à¸´à¸ˆà¸±à¸¢", sapa_approved:9090000, rolling_2568:813000, progress:0,
      main_projects:[
        {
          id:"PT2-2569-001", name:"à¹‚à¸„à¸£à¸‡à¸à¸²à¸£à¸ªà¸™à¸±à¸šà¸ªà¸™à¸¸à¸™à¸‡à¸šà¸›à¸£à¸°à¸¡à¸²à¸“à¸à¸²à¸£à¸—à¸³à¸§à¸´à¸ˆà¸±à¸¢à¹ƒà¸™à¸£à¸¹à¸›à¹à¸šà¸šà¹€à¸„à¸£à¸”à¸´à¸•à¸¯", fiscal_year:"2569", responsible:"à¸„à¸¸à¸“à¹€à¸­à¸¡à¸­à¸£",
          sapa_approved:7090000, rolling:0, proposed_budget:12552000,
          q1_plan:0,q2_plan:0,q3_plan:0,q4_plan:0, actual_spent:0,
          progress:0, problem:"",
          sub_projects:[]
        }
      ]
    }
  ];

  const clamp = (n,min=0,max=100)=>Math.max(min,Math.min(max,Number(n??0)));

  function normalizeStatusProgress(status, progress){
    const p = clamp(progress);
    const s = status || "pending";
    if (s==="completed" || p===100) return { status:"completed", progress:100 };
    if (p>0) return { status:"in_progress", progress:p };
    return { status:"pending", progress:0 };
  }

  function computeProjectKPI(project){
    let total=0, earned=0;
    (project.sub_projects||[]).forEach(sp=>{
      (sp.topics||[]).forEach(tp=>{
        (tp.details||[]).forEach(d=>{
          const pts=Number(d.points||0);
          const prog=clamp(d.progress);
          total += pts;
          earned += pts*(prog/100);
        });
      });
    });
    const progress = total>0 ? Math.round((earned/total)*100) : 0;
    return { total, earned, progress };
  }

  function computeMissionKPI(mission){
    let total=0, earned=0;
    (mission.main_projects||[]).forEach(p=>{
      const k=computeProjectKPI(p);
      total += k.total; earned += k.earned;
    });
    const progress = total>0 ? Math.round((earned/total)*100) : 0;
    return { total, earned, progress };
  }

  function recomputeAll(data){
    return (data||[]).map(m=>{
      const main_projects = (m.main_projects||[]).map(p=>{
        const k=computeProjectKPI(p);
        return { ...p, progress:k.progress, kpi_total_points:k.total };
      });
      const mk = computeMissionKPI({ ...m, main_projects });
      return { ...m, main_projects, progress:mk.progress, kpi_total_points:mk.total };
    });
  }

  function uid(prefix="ID"){
    return `${prefix}-${Date.now()}-${Math.floor(Math.random()*1000)}`;
  }

  function SemiGauge({ value=0, label="" }){
    const v = clamp(value);
    const radius=48, stroke=10, cx=60, cy=60;
    const startX=cx-radius, startY=cy, endX=cx+radius, endY=cy;
    const arcLength=Math.PI*radius;
    const dash=(arcLength*v)/100;

    return React.createElement("div", { style:{ display:"flex", flexDirection:"column", alignItems:"center"} },
      React.createElement("svg", { width:120, height:72, viewBox:"0 0 120 72" },
        React.createElement("path", {
          d:`M ${startX} ${startY} A ${radius} ${radius} 0 0 1 ${endX} ${endY}`,
          fill:"none", stroke:"#e2e8f0", strokeWidth:stroke, strokeLinecap:"round"
        }),
        React.createElement("path", {
          d:`M ${startX} ${startY} A ${radius} ${radius} 0 0 1 ${endX} ${endY}`,
          fill:"none", stroke:(v===100?THEME.primary:THEME.accent),
          strokeWidth:stroke, strokeLinecap:"round",
          strokeDasharray:`${dash} ${arcLength}`
        })
      ),
      React.createElement("div", { style:{ fontSize:18, fontWeight:900, marginTop:-8 } }, `${v}%`),
      label ? React.createElement("div", { style:{ fontSize:10, fontWeight:900, color:"#64748b" } }, label) : null
    );
  }

  function StatusBadge({ status }){
    if (status==="completed") return React.createElement("span",{className:"pill green"},"à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§");
    if (status==="in_progress") return React.createElement("span",{className:"pill yellow"},"à¸à¸³à¸¥à¸±à¸‡à¸—à¸³");
    return React.createElement("span",{className:"pill gray"},"à¸£à¸­à¹€à¸£à¸´à¹ˆà¸¡");
  }

  // FIXED: Use React.memo() to prevent re-creation and maintain input focus
  const FieldInput = React.memo(function FieldInput({ label, value, onChange, colSpan, placeholder }){
    return React.createElement("div",{style: colSpan ? {gridColumn:`span ${colSpan}`} : null},
      React.createElement("div",{className:"label"},label),
      React.createElement("input",{
        value: value,
        onChange: (e) => onChange(e.target.value),
        placeholder: placeholder || ""
      })
    );
  });

  const FieldNumber = React.memo(function FieldNumber({ label, value, onChange }){
    return React.createElement("div",null,
      React.createElement("div",{className:"label"},label),
      React.createElement("input",{
        type: "number",
        value: value,
        onChange: (e) => onChange(e.target.value)
      })
    );
  });

  const FieldSelect = React.memo(function FieldSelect({ label, value, onChange, options }){
    return React.createElement("div",null,
      React.createElement("div",{className:"label"},label),
      React.createElement("select",{
        value: value,
        onChange: (e) => onChange(e.target.value)
      },
        options.map(o => React.createElement("option",{key:o.value,value:o.value},o.label))
      )
    );
  });

  function App(){
    const [view,setView]=useState("dashboard");
    const [user, setUser]=useState(null);
    const [loginForm, setLoginForm]=useState({ username:"", password:"", error:"" });
    const [sidebarOpen, setSidebarOpen]=useState(false);
    const [data,setData]=useState(()=>recomputeAll(INITIAL_DATA));

    const [projectFormOpen,setProjectFormOpen]=useState(false);
    const [projectForm,setProjectForm]=useState({
      mode:"create", missionId:"PT1", id:"",
      fiscal_year:"2569", name:"", responsible:"",
      sapa_approved:0, rolling:0, proposed_budget:0,
      q1_plan:0,q2_plan:0,q3_plan:0,q4_plan:0
    });

    const [projectModal,setProjectModal]=useState({ open:false, missionId:"", projectId:"" });

    const [simpleAddModal,setSimpleAddModal]=useState({
      open:false, level:0, missionId:"", projectId:"", parentId:"",
      name:"", title:""
    });

    const [activityModal,setActivityModal]=useState({
      open:false, mode:"create",
      missionId:"", projectId:"", parentTopicId:"",
      activityId:"",
      name:"", description:"", problem:"",
      points:10, progress:0, status:"pending"
    });

    const [selectedProjects, setSelectedProjects] = useState({});

    const overallProgress = useMemo(()=>{
      const arr=data.map(m=>clamp(m.progress));
      return arr.length ? Math.round(arr.reduce((a,b)=>a+b,0)/arr.length) : 0;
    },[data]);

    // Authentication handlers
    function handleLogin(e){
      e.preventDefault();
      const foundUser = INITIAL_USERS.find(u => 
        u.username === loginForm.username && u.password === loginForm.password
      );
      if(foundUser){
        setUser(foundUser);
        setLoginForm({ username:"", password:"", error:"" });
      } else {
        setLoginForm({ ...loginForm, error:"Invalid username or password" });
      }
    }

    function handleDemoLogin(username, password){
      setLoginForm({ username, password, error:"" });
      const foundUser = INITIAL_USERS.find(u => u.username === username && u.password === password);
      if(foundUser) setUser(foundUser);
    }

    function handleLogout(){
      setUser(null);
      setView("dashboard");
      setSidebarOpen(false);
    }

    function toggleSidebar(){
      setSidebarOpen(!sidebarOpen);
    }

    function closeSidebar(){
      setSidebarOpen(false);
    }

    // Permission checks
    const canEdit = user?.role === "admin";
    const canCreate = user?.role === "admin";
    const canDelete = user?.role === "admin";

    const toggleProjectSelection = useCallback((missionId, projectId) => {
      setSelectedProjects(prev => {
        const key = `${missionId}::${projectId}`;
        return { ...prev, [key]: !prev[key] };
      });
    }, []);

    const toggleSelectAll = useCallback(() => {
      const allProjects = {};
      data.forEach(m => {
        m.main_projects.forEach(p => {
          allProjects[`${m.id}::${p.id}`] = true;
        });
      });
      const allSelected = Object.keys(selectedProjects).length === Object.keys(allProjects).length;
      setSelectedProjects(allSelected ? {} : allProjects);
    }, [data, selectedProjects]);

    function exportComprehensiveExcel() {
      if (Object.keys(selectedProjects).length === 0) {
        alert("à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¹‚à¸„à¸£à¸‡à¸à¸²à¸£à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£ Export à¸­à¸¢à¹ˆà¸²à¸‡à¸™à¹‰à¸­à¸¢ 1 à¹‚à¸„à¸£à¸‡à¸à¸²à¸£");
        return;
      }

      const wb = XLSX.utils.book_new();

      const summaryData = [
        ["MIS BUDGET SYSTEM - SUMMARY DASHBOARD"],
        ["Generated:", new Date().toLocaleString('th-TH')],
        [],
        ["Mission", "Total Budget", "Actual Spent", "KPI Progress %", "Total KPI Points"],
      ];

      data.forEach(m => {
        const totalBudget = Number(m.sapa_approved || 0);
        const actualSpent = m.main_projects.reduce((s,p)=>s+Number(p.actual_spent||0), 0);
        summaryData.push([
          `${m.id} - ${m.name}`,
          totalBudget,
          actualSpent,
          m.progress || 0,
          m.kpi_total_points || 0
        ]);
      });

      summaryData.push([]);
      summaryData.push(["OVERALL PROGRESS:", "", "", overallProgress + "%"]);

      const summaryWS = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, summaryWS, "Dashboard");

      data.forEach(mission => {
        mission.main_projects.forEach(project => {
          const key = `${mission.id}::${project.id}`;
          if (!selectedProjects[key]) return;

          const projectData = [];
          
          projectData.push([`PROJECT: ${project.name}`]);
          projectData.push([`ID: ${project.id}`, `Mission: ${mission.name}`]);
          projectData.push([`Responsible: ${project.responsible || "N/A"}`]);
          projectData.push([]);

          projectData.push(["BUDGET INFORMATION"]);
          projectData.push(["Sapa Approved", Number(project.sapa_approved || 0)]);
          projectData.push(["Rolling 2568", Number(project.rolling || 0)]);
          projectData.push(["Net Approved", Number(project.sapa_approved || 0) + Number(project.rolling || 0)]);
          projectData.push(["Proposed Budget", Number(project.proposed_budget || 0)]);
          projectData.push(["Q1 Plan", Number(project.q1_plan || 0)]);
          projectData.push(["Q2 Plan", Number(project.q2_plan || 0)]);
          projectData.push(["Q3 Plan", Number(project.q3_plan || 0)]);
          projectData.push(["Q4 Plan", Number(project.q4_plan || 0)]);
          projectData.push(["Actual Spent", Number(project.actual_spent || 0)]);
          projectData.push([]);

          projectData.push(["KPI INFORMATION"]);
          projectData.push(["Total KPI Points", project.kpi_total_points || 0]);
          projectData.push(["Progress %", project.progress || 0]);
          if (project.problem) {
            projectData.push(["Problem/Obstacle", project.problem]);
          }
          projectData.push([]);

          projectData.push(["HIERARCHY & ACTIVITIES"]);
          projectData.push([]);

          (project.sub_projects || []).forEach((sub, subIdx) => {
            projectData.push([`[Lv.3] Sub Project ${subIdx + 1}: ${sub.name}`]);
            projectData.push([]);

            (sub.topics || []).forEach((topic, topicIdx) => {
              projectData.push([`  [Lv.4] Topic ${topicIdx + 1}: ${topic.name}`]);
              projectData.push(["    Activity Name", "Description", "Status", "Progress %", "KPI Points", "Problem"]);

              (topic.details || []).forEach(activity => {
                projectData.push([
                  `    ${activity.name}`,
                  activity.description || "",
                  activity.status || "pending",
                  activity.progress || 0,
                  activity.points || 0,
                  activity.problem || ""
                ]);
              });

              projectData.push([]);
            });
          });

          const projectWS = XLSX.utils.aoa_to_sheet(projectData);
          const sheetName = `${project.id}`.substring(0, 31);
          XLSX.utils.book_append_sheet(wb, projectWS, sheetName);
        });
      });

      const budgetData = [
        ["ALL PROJECTS - BUDGET SUMMARY"],
        ["Mission", "Project ID", "Project Name", "Responsible", "Net Sapa", "Sapa Approved", "Rolling", "Proposed", "Q1", "Q2", "Q3", "Q4", "KPI Progress %"]
      ];

      data.forEach(m => {
        m.main_projects.forEach(p => {
          const net = Number(p.sapa_approved || 0) + Number(p.rolling || 0);
          budgetData.push([
            m.id,
            p.id,
            p.name,
            p.responsible || "",
            net,
            p.sapa_approved || 0,
            p.rolling || 0,
            p.proposed_budget || 0,
            p.q1_plan || 0,
            p.q2_plan || 0,
            p.q3_plan || 0,
            p.q4_plan || 0,
            p.progress || 0
          ]);
        });
      });

      const budgetWS = XLSX.utils.aoa_to_sheet(budgetData);
      XLSX.utils.book_append_sheet(wb, budgetWS, "Budget Summary");

      XLSX.writeFile(wb, `MIS_Comprehensive_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    function openCreateProject(missionId="PT1"){
      setProjectForm({
        mode:"create", missionId, id:"",
        fiscal_year:"2569", name:"", responsible:"",
        sapa_approved:0, rolling:0, proposed_budget:0,
        q1_plan:0,q2_plan:0,q3_plan:0,q4_plan:0
      });
      setProjectFormOpen(true);
    }

    function openEditProject(missionId, p){
      setProjectForm({
        mode:"edit", missionId, id:p.id,
        fiscal_year:p.fiscal_year||"2569",
        name:p.name||"", responsible:p.responsible||"",
        sapa_approved:Number(p.sapa_approved||0),
        rolling:Number(p.rolling||0),
        proposed_budget:Number(p.proposed_budget||0),
        q1_plan:Number(p.q1_plan||0), q2_plan:Number(p.q2_plan||0),
        q3_plan:Number(p.q3_plan||0), q4_plan:Number(p.q4_plan||0)
      });
      setProjectFormOpen(true);
    }

    function saveProject(){
      if(!projectForm.name.trim()) return;

      const net = Number(projectForm.sapa_approved||0)+Number(projectForm.rolling||0);
      const qsum = Number(projectForm.q1_plan)+Number(projectForm.q2_plan)+Number(projectForm.q3_plan)+Number(projectForm.q4_plan);
      if(qsum>net){
        alert("à¸¢à¸­à¸”à¸£à¸§à¸¡à¸£à¸²à¸¢à¹„à¸•à¸£à¸¡à¸²à¸ªà¹€à¸à¸´à¸™à¸‡à¸šà¸ªà¸ à¸²à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¸ªà¸¸à¸—à¸˜à¸´!");
        return;
      }

      const newData = data.map(m=>{
        if(m.id!==projectForm.missionId) return m;
        const idx = m.main_projects.findIndex(p=>p.id===projectForm.id);
        const newId = projectForm.mode==="create"
          ? `${m.id}-${projectForm.fiscal_year}-` + String(m.main_projects.length+1).padStart(3,"0")
          : projectForm.id;

        const baseOld = idx>=0 ? m.main_projects[idx] : null;

        const obj = {
          ...(baseOld||{}),
          id:newId,
          fiscal_year:projectForm.fiscal_year,
          name:projectForm.name,
          responsible:projectForm.responsible,
          sapa_approved:Number(projectForm.sapa_approved||0),
          rolling:Number(projectForm.rolling||0),
          proposed_budget:Number(projectForm.proposed_budget||0),
          q1_plan:Number(projectForm.q1_plan||0),
          q2_plan:Number(projectForm.q2_plan||0),
          q3_plan:Number(projectForm.q3_plan||0),
          q4_plan:Number(projectForm.q4_plan||0),
          actual_spent:Number(baseOld?.actual_spent||0),
          problem:baseOld?.problem||"",
          sub_projects:baseOld?.sub_projects||[],
          progress:Number(baseOld?.progress||0),
        };

        const arr=[...m.main_projects];
        if(idx>=0) arr[idx]=obj; else arr.push(obj);
        return { ...m, main_projects:arr };
      });

      setData(recomputeAll(newData));
      setProjectFormOpen(false);
    }

    function openProjectModal(missionId, projectId){
      setProjectModal({ open:true, missionId, projectId });
    }

    const currentMission = useMemo(()=>data.find(m=>m.id===projectModal.missionId),[data,projectModal.missionId]);
    const currentProject = useMemo(()=>currentMission?.main_projects?.find(p=>p.id===projectModal.projectId),[currentMission,projectModal.projectId]);

    function openAddLv3(){
      setSimpleAddModal({
        open:true, level:3,
        missionId:projectModal.missionId,
        projectId:projectModal.projectId,
        parentId:projectModal.projectId,
        name:"",
        title:"Sub Project (Lv.3)"
      });
    }
    function openAddLv4(subId){
      setSimpleAddModal({
        open:true, level:4,
        missionId:projectModal.missionId,
        projectId:projectModal.projectId,
        parentId:subId,
        name:"",
        title:"Topic (Lv.4)"
      });
    }
    function saveSimpleAdd(){
      if(!simpleAddModal.name.trim()) return;
      const newData = data.map(m=>{
        if(m.id!==simpleAddModal.missionId) return m;
        const main_projects = m.main_projects.map(p=>{
          if(p.id!==simpleAddModal.projectId) return p;

          if(simpleAddModal.level===3){
            const sp = { id:uid("SUB"), name:simpleAddModal.name, topics:[] };
            return { ...p, sub_projects:[...(p.sub_projects||[]), sp] };
          }

          if(simpleAddModal.level===4){
            const subs = (p.sub_projects||[]).map(sp=>{
              if(sp.id!==simpleAddModal.parentId) return sp;
              const tp = { id:uid("TOP"), name:simpleAddModal.name, details:[] };
              return { ...sp, topics:[...(sp.topics||[]), tp] };
            });
            return { ...p, sub_projects:subs };
          }

          return p;
        });
        return { ...m, main_projects };
      });

      setData(recomputeAll(newData));
      setSimpleAddModal({ ...simpleAddModal, open:false, name:"" });
    }

    function openCreateActivity(topicId){
      setActivityModal({
        open:true, mode:"create",
        missionId:projectModal.missionId,
        projectId:projectModal.projectId,
        parentTopicId:topicId,
        activityId:"",
        name:"", description:"", problem:"",
        points:10, progress:0, status:"pending"
      });
    }
    function openEditActivity(topicId, d){
      setActivityModal({
        open:true, mode:"edit",
        missionId:projectModal.missionId,
        projectId:projectModal.projectId,
        parentTopicId:topicId,
        activityId:d.id,
        name:d.name||"",
        description:d.description||"",
        problem:d.problem||"",
        points:Number(d.points||10),
        progress:Number(d.progress||0),
        status:d.status||"pending"
      });
    }
    function saveActivity(){
      if(!activityModal.name.trim()) return;
      const norm = normalizeStatusProgress(activityModal.status, activityModal.progress);

      const newData = data.map(m=>{
        if(m.id!==activityModal.missionId) return m;
        const main_projects = m.main_projects.map(p=>{
          if(p.id!==activityModal.projectId) return p;

          const sub_projects = (p.sub_projects||[]).map(sp=>{
            const topics = (sp.topics||[]).map(tp=>{
              if(tp.id!==activityModal.parentTopicId) return tp;

              const details=[...(tp.details||[])];

              if(activityModal.mode==="create"){
                details.push({
                  id:uid("ACT"),
                  name:activityModal.name,
                  description:activityModal.description,
                  problem:activityModal.problem,
                  points:Number(activityModal.points||0),
                  progress:Number(norm.progress),
                  status:norm.status
                });
              }else{
                const idx=details.findIndex(x=>x.id===activityModal.activityId);
                if(idx>=0){
                  details[idx]={
                    ...details[idx],
                    name:activityModal.name,
                    description:activityModal.description,
                    problem:activityModal.problem,
                    points:Number(activityModal.points||0),
                    progress:Number(norm.progress),
                    status:norm.status
                  };
                }
              }

              return { ...tp, details };
            });
            return { ...sp, topics };
          });

          return { ...p, sub_projects };
        });
        return { ...m, main_projects };
      });

      setData(recomputeAll(newData));
      setActivityModal({ ...activityModal, open:false });
    }

    function exportBudgetCSV(){
      const rows=[];
      rows.push(["Mission","ProjectId","ProjectName","Responsible","NetSapa","SapaApproved","Rolling","Proposed","Q1","Q2","Q3","Q4","KPIProgress(%)"]);
      data.forEach(m=>{
        m.main_projects.forEach(p=>{
          const net=Number(p.sapa_approved||0)+Number(p.rolling||0);
          rows.push([m.id,p.id,p.name,p.responsible||"",net,p.sapa_approved||0,p.rolling||0,p.proposed_budget||0,p.q1_plan||0,p.q2_plan||0,p.q3_plan||0,p.q4_plan||0,p.progress||0]);
        });
      });
      const csv = rows.map(r=>r.map(v=>{
        const s=String(v??"");
        if(s.includes(",")||s.includes('"')||s.includes("\n")) return `"${s.replace(/"/g,'""')}"`;
        return s;
      }).join(",")).join("\n");
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="budget_export.csv";
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function Sidebar(){
      return React.createElement("aside",{className:"sidebar" + (sidebarOpen?" open":"")},
        React.createElement("div",{className:"brand"},
          React.createElement("div",{className:"logo"},"M"),
          React.createElement("div",{style:{fontSize:22,fontWeight:900}},"MIS")
        ),
        NavButton("dashboard","ðŸ“Š Dashboard"),
        NavButton("explorer","ðŸ§­ Explorer (Lv.1-5)"),
        NavButton("budget","ðŸ’° Budget"),
        NavButton("reports","ðŸ“ˆ Reports & KPI"),
        React.createElement("div",{style:{marginTop:"auto",borderTop:"1px solid rgba(255,255,255,.12)",paddingTop:14}},
          React.createElement("div",{className:"userInfo"},
            React.createElement("div",{className:"userAvatar"},user.name.charAt(0)),
            React.createElement("div",{style:{flex:1,minWidth:0}},
              React.createElement("div",{style:{fontSize:12,fontWeight:900,opacity:.92,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},user.name),
              React.createElement("span",{className:"roleBadge " + user.role},user.role)
            )
          ),
          React.createElement("button",{className:"navbtn",onClick:handleLogout}, "âŽ‹ Logout")
        )
      );
    }

    function LoginPage(){
      return React.createElement("div",{className:"loginContainer"},
        React.createElement("div",{className:"loginCard"},
          React.createElement("div",{className:"loginLogo"},"M"),
          React.createElement("div",{className:"loginTitle"},"MIS Budget System"),
          React.createElement("div",{className:"loginSubtitle"},"à¸£à¸°à¸šà¸šà¸šà¸£à¸´à¸«à¸²à¸£à¸ˆà¸±à¸”à¸à¸²à¸£à¸‡à¸šà¸›à¸£à¸°à¸¡à¸²à¸“ FY 2569"),
          
          loginForm.error ? React.createElement("div",{className:"errorMsg"},loginForm.error) : null,
          
          React.createElement("form",{className:"loginForm",onSubmit:handleLogin},
            React.createElement("div",{className:"loginField"},
              React.createElement("label",{className:"loginLabel"},"Username"),
              React.createElement("input",{
                className:"loginInput",
                type:"text",
                value:loginForm.username,
                onChange:(e)=>setLoginForm({...loginForm,username:e.target.value}),
                placeholder:"Enter username",
                required:true
              })
            ),
            React.createElement("div",{className:"loginField"},
              React.createElement("label",{className:"loginLabel"},"Password"),
              React.createElement("input",{
                className:"loginInput",
                type:"password",
                value:loginForm.password,
                onChange:(e)=>setLoginForm({...loginForm,password:e.target.value}),
                placeholder:"Enter password",
                required:true
              })
            ),
            React.createElement("button",{className:"loginButton",type:"submit"},"ðŸ” Login")
          ),
          
          React.createElement("div",{className:"demoAccounts"},
            React.createElement("div",{className:"demoTitle"},"ðŸ“‹ Demo Accounts (Click to Auto-fill)"),
            React.createElement("div",{
              className:"demoAccount",
              onClick:()=>handleDemoLogin("admin","123")
            },
              React.createElement("div",null,
                React.createElement("div",{className:"demoRole"},"ðŸ‘‘ Administrator"),
                React.createElement("div",{className:"demoCredentials"},"Full access â€¢ Create/Edit/Delete")
              ),
              React.createElement("div",{style:{fontSize:11,fontWeight:900,color:"#64748b"}},"admin / 123")
            ),
            React.createElement("div",{
              className:"demoAccount",
              onClick:()=>handleDemoLogin("user","123")
            },
              React.createElement("div",null,
                React.createElement("div",{className:"demoRole"},"ðŸ‘¤ User (Read-Only)"),
                React.createElement("div",{className:"demoCredentials"},"View only â€¢ No edit permissions")
              ),
              React.createElement("div",{style:{fontSize:11,fontWeight:900,color:"#64748b"}},"user / 123")
            )
          )
        )
      );
    }

    function NavButton(key,label){
      return React.createElement("button",{
        className:"navbtn"+(view===key?" active":""),
        onClick:()=>setView(key)
      }, label);
    }

    function Dashboard(){
      const totalBudget = data.reduce((s,m)=>s+Number(m.sapa_approved||0),0);
      const actualSpent = data.flatMap(m=>m.main_projects).reduce((s,p)=>s+Number(p.actual_spent||0),0);

      return React.createElement("div",{style:{display:"grid",gap:12}},
        React.createElement("div",{className:"grid4"},
          CardStat("Total Budget","à¸¿"+totalBudget.toLocaleString()),
          CardStat("Actual Spent","à¸¿"+actualSpent.toLocaleString()),
          CardStat("Progress",overallProgress+"%"),
          CardStat("KPI Score",overallProgress+"%")
        ),
        React.createElement("div",{className:"row"},
          React.createElement("div",{className:"card half"},
            React.createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"}},
              React.createElement("div",{style:{fontWeight:900}},"Mission KPI (Semi Gauge)"),
              React.createElement("span",{className:"pill red"},"100% = à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§")
            ),
            React.createElement("div",{style:{marginTop:12,display:"grid",gap:10}},
              data.map(m=>React.createElement("div",{key:m.id,style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:12,border:"1px solid var(--border)",borderRadius:16}},
                React.createElement("div",null,
                  React.createElement("div",{style:{fontWeight:900}},m.name),
                  React.createElement("div",{className:"muted"},(m.kpi_total_points||0)+" KPI pts")
                ),
                React.createElement(SemiGauge,{value:m.progress,label:m.id})
              ))
            )
          ),
          React.createElement("div",{className:"card half"},
            React.createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"}},
              React.createElement("div",{style:{fontWeight:900}},"Quick Actions"),
              React.createElement("button",{className:"btnPrimary",onClick:()=>setView("explorer")},"â†— Open Explorer")
            ),
            React.createElement("div",{style:{marginTop:14,display:"grid",gap:10}},
              canCreate ? React.createElement("button",{className:"btnSoft",onClick:()=>openCreateProject("PT1")},"ï¼‹ Create New Project (Lv.2)") : null,
              React.createElement("button",{className:"btnSoft",onClick:()=>setView("budget")},"ðŸ’° Go to Budget"),
              React.createElement("button",{className:"btnSoft",onClick:()=>setView("reports")},"ðŸ“ˆ Reports & KPI")
            ),
            !canCreate ? React.createElement("div",{style:{marginTop:10,padding:12,background:"#fef9c3",borderRadius:12,fontSize:12,fontWeight:900,color:"#854d0e"}},"â„¹ï¸ Read-only mode - Login as Admin to create/edit") : null
          )
        )
      );
    }

    function Explorer(){
      return React.createElement("div",{style:{display:"grid",gap:12}},
        React.createElement("div",{className:"card",style:{background:"var(--secondary)",color:"#fff",borderColor:"transparent"}},
          React.createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:12}},
            React.createElement("div",null,
              React.createElement("div",{style:{fontSize:20,fontWeight:900}},"Hierarchy Explorer"),
              React.createElement("div",{style:{fontSize:12,fontWeight:900,opacity:.6}},"Manage Lv.1 to Lv.5 Activities")
            ),
            canCreate ? React.createElement("button",{className:"btnPrimary",style:{background:"#fff",color:"#111827"},onClick:()=>openCreateProject("PT1")},"ï¼‹ Create Project") : null
          )
        ),
        data.map(m=>React.createElement("div",{key:m.id,className:"card"},
          React.createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:12}},
            React.createElement("div",null,
              React.createElement("div",{style:{fontWeight:900,fontSize:16}},`${m.id} â€¢ ${m.name}`),
              React.createElement("div",{className:"muted"},`${m.main_projects.length} projects`)
            ),
            React.createElement("div",{style:{display:"flex",gap:10,alignItems:"center",flexWrap:"wrap"}},
              canCreate ? React.createElement("button",{className:"btnSoft",onClick:()=>openCreateProject(m.id)},"ï¼‹ Add Project") : null,
              React.createElement(SemiGauge,{value:m.progress,label:"Mission"})
            )
          ),
          React.createElement("div",{style:{marginTop:12,display:"grid",gap:10}},
            m.main_projects.map(p=>React.createElement("div",{key:p.id,style:{padding:12,border:"1px solid var(--border)",borderRadius:16,display:"flex",justifyContent:"space-between",alignItems:"center",gap:12,flexWrap:"wrap"}},
              React.createElement("div",{style:{minWidth:0,flex:"1 1 200px"}},
                React.createElement("div",{style:{fontSize:12,fontWeight:900,color:"var(--primary)"}},p.id),
                React.createElement("div",{style:{fontSize:14,fontWeight:900},className:"ellipsis"},p.name),
                React.createElement("div",{className:"muted"},`${p.responsible||"N/A"} â€¢ ${(p.kpi_total_points||0)} pts`)
              ),
              React.createElement("div",{style:{display:"flex",gap:10,alignItems:"center",flexWrap:"wrap"}},
                canEdit ? React.createElement("button",{className:"btnSoft",onClick:()=>openEditProject(m.id,p)},"âœŽ") : null,
                React.createElement("button",{className:"btnPrimary",onClick:()=>openProjectModal(m.id,p.id)},"Open Detail"),
                React.createElement(SemiGauge,{value:p.progress,label:"Project"})
              )
            )),
            m.main_projects.length===0 ? React.createElement("div",{style:{padding:14,color:"#94a3b8",fontWeight:900,fontSize:12}},"No projects") : null
          )
        ))
      );
    }

    function Budget(){
      return React.createElement("div",{style:{display:"grid",gap:12}},
        React.createElement("div",{className:"card"},
          React.createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:12}},
            React.createElement("div",null,
              React.createElement("div",{style:{fontWeight:900,fontSize:18}},"Budget Management"),
              React.createElement("div",{className:"muted"},"Create / Edit budget records by project")
            ),
            React.createElement("div",{style:{display:"flex",gap:10,flexWrap:"wrap"}},
              React.createElement("button",{className:"btnSoft",onClick:exportBudgetCSV},"Export CSV"),
              canCreate ? React.createElement("button",{className:"btnPrimary",onClick:()=>openCreateProject("PT1")},"ï¼‹ New Entry") : null
            )
          )
        ),
        React.createElement("div",{className:"card",style:{overflowX:"auto"}},
          React.createElement("table",null,
            React.createElement("thead",null,
              React.createElement("tr",null,
                React.createElement("th",null,"Project"),
                React.createElement("th",null,"Responsible"),
                React.createElement("th",{style:{textAlign:"right"}},"Net Approved"),
                React.createElement("th",{style:{textAlign:"center"}},"KPI"),
                React.createElement("th",{style:{textAlign:"center"}},"Action")
              )
            ),
            React.createElement("tbody",null,
              data.flatMap(m=>m.main_projects.map(p=>({ missionId:m.id, ...p }))).map(p=>{
                const net = Number(p.sapa_approved||0)+Number(p.rolling||0);
                return React.createElement("tr",{key:p.id},
                  React.createElement("td",null,
                    React.createElement("div",{style:{fontSize:12,fontWeight:900,color:"var(--primary)"}},p.id),
                    React.createElement("div",{style:{fontWeight:900}},p.name),
                    p.problem ? React.createElement("div",{className:"danger",style:{marginTop:6}},"âš  ",p.problem) : null
                  ),
                  React.createElement("td",null,p.responsible||"-"),
                  React.createElement("td",{style:{textAlign:"right",fontWeight:900}},"à¸¿"+net.toLocaleString()),
                  React.createElement("td",{style:{textAlign:"center"}},
                    React.createElement("span",{className:"pill gray"},(p.progress||0)+"%")
                  ),
                  React.createElement("td",{style:{textAlign:"center"}},
                    React.createElement("div",{style:{display:"flex",justifyContent:"center",gap:10,flexWrap:"wrap"}},
                      canEdit ? React.createElement("button",{className:"btnSoft",onClick:()=>openEditProject(p.missionId,p)},"âœŽ") : null,
                      React.createElement("button",{className:"btnPrimary",onClick:()=>openProjectModal(p.missionId,p.id)},"Detail")
                    )
                  )
                );
              })
            )
          )
        )
      );
    }

    function Reports(){
      const selectedCount = Object.values(selectedProjects).filter(Boolean).length;
      const totalProjects = data.flatMap(m => m.main_projects).length;

      return React.createElement("div",{style:{display:"grid",gap:12}},
        React.createElement("div",{className:"card"},
          React.createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"}},
            React.createElement("div",null,
              React.createElement("div",{style:{fontWeight:900,fontSize:18}},"Reports & KPI"),
              React.createElement("div",{className:"muted"},"à¹€à¸¥à¸·à¸­à¸à¹‚à¸„à¸£à¸‡à¸à¸²à¸£à¹à¸¥à¸° Export à¸£à¸²à¸¢à¸‡à¸²à¸™à¹à¸šà¸šà¸„à¸£à¸šà¸–à¹‰à¸§à¸™")
            ),
            React.createElement("span",{className:"pill red"},"Overall "+overallProgress+"%")
          )
        ),

        React.createElement("div",{className:"selectionInfo"},
          React.createElement("div",null,
            React.createElement("span",{className:"pill blue",style:{marginRight:8}},`à¹€à¸¥à¸·à¸­à¸à¹à¸¥à¹‰à¸§ ${selectedCount} / ${totalProjects}`),
            React.createElement("button",{
              className:"btnSoft",
              style:{marginLeft:8},
              onClick:toggleSelectAll
            }, selectedCount === totalProjects ? "âœ• à¸¢à¸à¹€à¸¥à¸´à¸à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”" : "âœ“ à¹€à¸¥à¸·à¸­à¸à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”")
          ),
          React.createElement("button",{
            className:"btnPrimary",
            onClick:exportComprehensiveExcel,
            disabled:selectedCount === 0
          }, `ðŸ“¥ Export Excel (${selectedCount} à¹‚à¸„à¸£à¸‡à¸à¸²à¸£)`)
        ),

        data.map(m=>React.createElement("div",{key:m.id,className:"card"},
          React.createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"}},
            React.createElement("div",null,
              React.createElement("div",{style:{fontWeight:900}},`${m.id} â€¢ ${m.name}`),
              React.createElement("div",{className:"muted"},`${m.main_projects.length} projects`)
            ),
            React.createElement(SemiGauge,{value:m.progress,label:"Mission KPI"})
          ),
          React.createElement("div",{style:{marginTop:12,display:"grid",gap:10}},
            m.main_projects.map(p=>{
              const key = `${m.id}::${p.id}`;
              const isSelected = selectedProjects[key];
              
              return React.createElement("div",{
                key:p.id,
                style:{
                  padding:12,
                  border:isSelected ? "2px solid var(--primary)" : "1px solid var(--border)",
                  borderRadius:16,
                  display:"flex",
                  justifyContent:"space-between",
                  alignItems:"center",
                  gap:12,
                  background: isSelected ? "#fef2f2" : "transparent"
                }
              },
                React.createElement("div",{style:{display:"flex",alignItems:"center",gap:12,minWidth:0}},
                  React.createElement("input",{
                    type:"checkbox",
                    className:"checkbox",
                    checked:isSelected||false,
                    onChange:()=>toggleProjectSelection(m.id, p.id)
                  }),
                  React.createElement("div",{style:{minWidth:0}},
                    React.createElement("div",{style:{fontSize:12,fontWeight:900,color:"var(--primary)"}},p.id),
                    React.createElement("div",{style:{fontSize:14,fontWeight:900},className:"ellipsis"},p.name),
                    React.createElement("div",{className:"muted"},
                      `Net Sapa: à¸¿${(Number(p.sapa_approved||0)+Number(p.rolling||0)).toLocaleString()} â€¢ KPI pts: ${p.kpi_total_points||0}`
                    )
                  )
                ),
                React.createElement("div",{style:{display:"flex",gap:10,alignItems:"center"}},
                  React.createElement("button",{className:"btnPrimary",onClick:()=>openProjectModal(m.id,p.id)},"Open Detail"),
                  React.createElement(SemiGauge,{value:p.progress,label:"Project KPI"})
                )
              );
            })
          )
        ))
      );
    }

    function CardStat(title,value){
      return React.createElement("div",{className:"card"},
        React.createElement("div",{className:"cardTitle"},title),
        React.createElement("div",{className:"cardValue"},value)
      );
    }

    function Header(){
      return React.createElement("div",{className:"header"},
        React.createElement("div",{style:{display:"flex",alignItems:"center",gap:10}},
          React.createElement("button",{className:"hamburger",onClick:toggleSidebar}, "â˜°"),
          React.createElement("div",{style:{fontSize:16,fontWeight:900,textTransform:"uppercase"}}, view),
          React.createElement("span",{className:"roleBadge " + user.role,style:{marginLeft:8}},user.role)
        ),
        React.createElement("div",{className:"muted"},"FY 2569")
      );
    }

    function ProjectFormModal(){
      if(!projectFormOpen) return null;

      const net = Number(projectForm.sapa_approved||0)+Number(projectForm.rolling||0);
      const qsum = Number(projectForm.q1_plan)+Number(projectForm.q2_plan)+Number(projectForm.q3_plan)+Number(projectForm.q4_plan);

      return React.createElement("div",{className:"modalOverlay"},
        React.createElement("div",{className:"modal",style:{width:"min(900px,96vw)"}},
          React.createElement("div",{className:"modalHead"},
            React.createElement("div",null,
              React.createElement("div",{style:{fontWeight:900,fontSize:18}},
                projectForm.mode==="create" ? "Create Project (Lv.2)" : "Edit Project (Lv.2)"
              ),
              React.createElement("div",{className:"muted"},"Budget fields + Q1â€“Q4 validation")
            ),
            React.createElement("button",{className:"btnSoft",onClick:()=>setProjectFormOpen(false)},"âœ•")
          ),
          React.createElement("div",{className:"modalBody"},
            React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}},
              React.createElement(FieldSelect, {
                label: "Mission",
                value: projectForm.missionId,
                onChange: (v) => setProjectForm({...projectForm, missionId:v}),
                options: data.map(m => ({value:m.id, label:`${m.id} - ${m.name}`}))
              }),
              React.createElement(FieldSelect, {
                label: "Fiscal Year",
                value: projectForm.fiscal_year,
                onChange: (v) => setProjectForm({...projectForm, fiscal_year:v}),
                options: [{value:"2569",label:"2569"},{value:"2570",label:"2570"}]
              }),
              React.createElement(FieldInput, {
                label: "Project Name",
                value: projectForm.name,
                onChange: (v) => setProjectForm({...projectForm, name:v}),
                colSpan: 2,
                placeholder: "à¸Šà¸·à¹ˆà¸­à¹‚à¸„à¸£à¸‡à¸à¸²à¸£..."
              }),
              React.createElement(FieldInput, {
                label: "Responsible",
                value: projectForm.responsible,
                onChange: (v) => setProjectForm({...projectForm, responsible:v}),
                colSpan: 2,
                placeholder: "à¸œà¸¹à¹‰à¸£à¸±à¸šà¸œà¸´à¸”à¸Šà¸­à¸š..."
              })
            ),

            React.createElement("div",{className:"card",style:{marginTop:14}},
              React.createElement("div",{style:{fontWeight:900,marginBottom:10}},"Financial Fields"),
              React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:12}},
                React.createElement(FieldNumber, {
                  label: "Sapa Approved",
                  value: projectForm.sapa_approved,
                  onChange: (v) => setProjectForm({...projectForm, sapa_approved:v})
                }),
                React.createElement(FieldNumber, {
                  label: "Proposed",
                  value: projectForm.proposed_budget,
                  onChange: (v) => setProjectForm({...projectForm, proposed_budget:v})
                }),
                React.createElement(FieldNumber, {
                  label: "Rolling 2568",
                  value: projectForm.rolling,
                  onChange: (v) => setProjectForm({...projectForm, rolling:v})
                })
              ),
              React.createElement("div",{style:{marginTop:12,display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:12}},
                React.createElement(FieldNumber, {
                  label: "Q1",
                  value: projectForm.q1_plan,
                  onChange: (v) => setProjectForm({...projectForm, q1_plan:v})
                }),
                React.createElement(FieldNumber, {
                  label: "Q2",
                  value: projectForm.q2_plan,
                  onChange: (v) => setProjectForm({...projectForm, q2_plan:v})
                }),
                React.createElement(FieldNumber, {
                  label: "Q3",
                  value: projectForm.q3_plan,
                  onChange: (v) => setProjectForm({...projectForm, q3_plan:v})
                }),
                React.createElement(FieldNumber, {
                  label: "Q4",
                  value: projectForm.q4_plan,
                  onChange: (v) => setProjectForm({...projectForm, q4_plan:v})
                })
              ),
              React.createElement("div",{style:{marginTop:12,display:"flex",justifyContent:"space-between",alignItems:"center",paddingTop:10,borderTop:"1px solid var(--border)"}},
                React.createElement("div",{className:"muted"},"Net Sapa: ",
                  React.createElement("span",{style:{color:"var(--primary)"}}, "à¸¿"+net.toLocaleString())
                ),
                React.createElement("div",{className:"muted"},"Total Q1â€“Q4: ",
                  React.createElement("span",{style:{color:"var(--text)"}}, "à¸¿"+qsum.toLocaleString()),
                  qsum>net ? React.createElement("span",{className:"pill red",style:{marginLeft:10}},"à¹€à¸à¸´à¸™à¸‡à¸š!") : null
                )
              )
            ),

            React.createElement("div",{style:{marginTop:14,display:"flex",gap:10,justifyContent:"flex-end"}},
              React.createElement("button",{className:"btnSoft",onClick:()=>setProjectFormOpen(false)},"Cancel"),
              React.createElement("button",{className:"btnPrimary",onClick:saveProject},"Save")
            )
          )
        )
      );
    }

    function SimpleAddModal(){
      if(!simpleAddModal.open) return null;
      return React.createElement("div",{className:"modalOverlay"},
        React.createElement("div",{className:"modal",style:{width:"min(720px,96vw)"}},
          React.createElement("div",{className:"modalHead"},
            React.createElement("div",null,
              React.createElement("div",{style:{fontWeight:900,fontSize:18}}, "Add New "+simpleAddModal.title),
              React.createElement("div",{className:"muted"},"à¹€à¸žà¸´à¹ˆà¸¡à¸£à¸²à¸¢à¸à¸²à¸£ Lv."+simpleAddModal.level)
            ),
            React.createElement("button",{className:"btnSoft",onClick:()=>setSimpleAddModal({...simpleAddModal,open:false})},"âœ•")
          ),
          React.createElement("div",{className:"modalBody"},
            React.createElement("div",{className:"label"},"Name"),
            React.createElement("input",{
              value: simpleAddModal.name,
              onChange: (e) => setSimpleAddModal({...simpleAddModal, name:e.target.value}),
              placeholder: "à¸Šà¸·à¹ˆà¸­à¸£à¸²à¸¢à¸à¸²à¸£..."
            }),
            React.createElement("div",{style:{marginTop:14,display:"flex",justifyContent:"flex-end",gap:10}},
              React.createElement("button",{className:"btnSoft",onClick:()=>setSimpleAddModal({...simpleAddModal,open:false})},"Cancel"),
              React.createElement("button",{className:"btnPrimary",onClick:saveSimpleAdd},"Save")
            )
          )
        )
      );
    }

    function ActivityModal(){
      if(!activityModal.open) return null;

      return React.createElement("div",{className:"modalOverlay"},
        React.createElement("div",{className:"modal",style:{width:"min(760px,96vw)"}},
          React.createElement("div",{className:"modalHead"},
            React.createElement("div",null,
              React.createElement("div",{style:{fontWeight:900,fontSize:18}},
                activityModal.mode==="create" ? "Add New Activity (Lv.5)" : "Update Activity (Lv.5)"
              ),
              React.createElement("div",{className:"muted"},"à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸” + à¸›à¸±à¸à¸«à¸²/à¸­à¸¸à¸›à¸ªà¸£à¸£à¸„ + à¸ªà¸–à¸²à¸™à¸°/Progress")
            ),
            React.createElement("button",{className:"btnSoft",onClick:()=>setActivityModal({...activityModal,open:false})},"âœ•")
          ),
          React.createElement("div",{className:"modalBody"},
            React.createElement("div",{style:{display:"grid",gap:12}},
              React.createElement("div",null,
                React.createElement("div",{className:"label"},"Activity Name"),
                React.createElement("input",{
                  value: activityModal.name,
                  onChange: (e) => setActivityModal({...activityModal, name:e.target.value}),
                  placeholder: "à¸Šà¸·à¹ˆà¸­à¸à¸´à¸ˆà¸à¸£à¸£à¸¡..."
                })
              ),
              React.createElement("div",null,
                React.createElement("div",{className:"label"},"Description"),
                React.createElement("textarea",{
                  value: activityModal.description,
                  onChange: (e) => setActivityModal({...activityModal, description:e.target.value}),
                  placeholder: "à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸à¸´à¸ˆà¸à¸£à¸£à¸¡..."
                })
              ),
              React.createElement("div",null,
                React.createElement("div",{className:"label"},"Problem / Obstacle"),
                React.createElement("textarea",{
                  value: activityModal.problem,
                  onChange: (e) => setActivityModal({...activityModal, problem:e.target.value}),
                  placeholder: "à¸›à¸±à¸à¸«à¸²/à¸­à¸¸à¸›à¸ªà¸£à¸£à¸„ (à¸–à¹‰à¸²à¸¡à¸µ)..."
                })
              ),
              React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}},
                React.createElement("div",null,
                  React.createElement("div",{className:"label"},"KPI Weight (points)"),
                  React.createElement("input",{
                    type: "number",
                    value: activityModal.points,
                    onChange: (e) => setActivityModal({...activityModal, points:e.target.value})
                  })
                ),
                React.createElement("div",null,
                  React.createElement("div",{className:"label"},"Progress (%)"),
                  React.createElement("input",{
                    type: "number",
                    value: activityModal.progress,
                    onChange: (e) => setActivityModal({...activityModal, progress:clamp(e.target.value)})
                  })
                )
              ),
              React.createElement("div",null,
                React.createElement("div",{className:"label"},"Status"),
                React.createElement("select",{
                  value: activityModal.status,
                  onChange: (e) => setActivityModal({...activityModal, status:e.target.value})
                },
                  React.createElement("option",{value:"pending"},"à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹€à¸ªà¸£à¹‡à¸ˆ (Not Started)"),
                  React.createElement("option",{value:"in_progress"},"à¸à¸³à¸¥à¸±à¸‡à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£ (In Progress)"),
                  React.createElement("option",{value:"completed"},"à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§ (Completed)")
                ),
                React.createElement("div",{className:"muted",style:{marginTop:8}},"* à¸–à¹‰à¸²à¹€à¸¥à¸·à¸­à¸ Completed à¸ˆà¸°à¸šà¸±à¸‡à¸„à¸±à¸šà¹€à¸›à¹‡à¸™ 100% à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´")
              ),
              React.createElement("div",{style:{display:"flex",justifyContent:"flex-end",gap:10}},
                React.createElement("button",{className:"btnSoft",onClick:()=>setActivityModal({...activityModal,open:false})},"Cancel"),
                React.createElement("button",{className:"btnPrimary",onClick:saveActivity},"Save")
              )
            )
          )
        )
      );
    }

    function ProjectDetailModal(){
      if(!projectModal.open || !currentProject) return null;

      return React.createElement("div",{className:"modalOverlay"},
        React.createElement("div",{className:"modal"},
          React.createElement("div",{className:"modalHead"},
            React.createElement("div",{style:{minWidth:0,flex:1}},
              React.createElement("div",{style:{fontWeight:900,fontSize:18},className:"ellipsis"}, currentProject.name),
              React.createElement("div",{className:"muted",style:{color:"var(--primary)",textTransform:"uppercase"}}, "Lv.2 Main Project Detail â€¢ "+currentProject.id)
            ),
            React.createElement("button",{className:"btnSoft",onClick:()=>setProjectModal({open:false,missionId:"",projectId:""})},"âœ•")
          ),
          React.createElement("div",{className:"modalBody"},
            React.createElement("div",{className:"card",style:{background:"#eff6ff",borderColor:"#dbeafe"}},
              React.createElement("div",{className:"label",style:{color:"#2563eb"}},"Weighted Score Logic (Example)"),
              React.createElement("div",{style:{fontSize:13,fontWeight:900,color:"#1e40af",marginTop:6}},
                "TOR (10) + Purchase (30) + Install (60 * 75% = 45) = ", React.createElement("b",null,"85 Points Total")
              )
            ),

            React.createElement("div",{style:{marginTop:12,display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:12}},
              canCreate ? React.createElement("button",{className:"btnSoft",style:{border:"2px dashed var(--primary)",color:"var(--primary)"},onClick:openAddLv3},"ï¼‹ Add Sub Project (Lv.3)") : null,
              React.createElement("div",{style:{display:"flex",gap:12,alignItems:"center",flexWrap:"wrap"}},
                React.createElement("span",{className:"pill red"},"Project KPI"),
                React.createElement(SemiGauge,{value:currentProject.progress,label:"100% = Completed"})
              )
            ),

            !canCreate ? React.createElement("div",{style:{marginTop:12,padding:12,background:"#fef9c3",borderRadius:12,fontSize:12,fontWeight:900,color:"#854d0e"}},"â„¹ï¸ Read-only mode - Login as Admin to add/edit activities") : null,

            React.createElement("div",{style:{marginTop:14,display:"grid",gap:14}},
              (currentProject.sub_projects||[]).length===0
                ? React.createElement("div",{style:{padding:14,border:"1px dashed #fecaca",borderRadius:16,color:"#991b1b",fontWeight:900}},
                    canCreate ? 'à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µ Sub Project (Lv.3) â€” à¸à¸” "Add Sub Project (Lv.3)"' : 'à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µ Sub Project (Lv.3)'
                  )
                : null,

              (currentProject.sub_projects||[]).map(sp=>React.createElement("div",{key:sp.id,className:"dividerL"},
                React.createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:10}},
                  React.createElement("div",{style:{fontWeight:900,fontSize:16}},
                    sp.name," ",React.createElement("span",{style:{color:"#64748b",fontSize:12}},"(Lv.3)")
                  ),
                  canCreate ? React.createElement("button",{className:"btnSoft",onClick:()=>openAddLv4(sp.id)},"ï¼‹ Topic (Lv.4)") : null
                ),

                React.createElement("div",{style:{marginTop:10,display:"grid",gap:12}},
                  (sp.topics||[]).length===0
                    ? React.createElement("div",{style:{padding:12,border:"1px dashed var(--border)",borderRadius:14,color:"#64748b",fontWeight:900}},
                        "à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µ Topic (Lv.4)"
                      )
                    : null,

                  (sp.topics||[]).map(tp=>React.createElement("div",{key:tp.id,style:{marginLeft:14}},
                    React.createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",borderBottom:"1px solid var(--border)",paddingBottom:6,flexWrap:"wrap",gap:10}},
                      React.createElement("div",{style:{fontWeight:900,color:"#475569",textTransform:"uppercase",fontSize:12,letterSpacing:.8}},
                        "Topic: ",tp.name," ",React.createElement("span",{style:{color:"#94a3b8"}},"(Lv.4)")
                      ),
                      canCreate ? React.createElement("button",{className:"btnPrimary",style:{background:"#2563eb"},onClick:()=>openCreateActivity(tp.id)},"ï¼‹ Activity (Lv.5)") : null
                    ),

                    React.createElement("div",{style:{marginTop:10,display:"grid",gap:10}},
                      (tp.details||[]).length===0
                        ? React.createElement("div",{style:{padding:12,border:"1px dashed var(--border)",borderRadius:14,color:"#64748b",fontWeight:900}},
                            canCreate ? 'à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µ Activity (Lv.5) â€” à¸„à¹ˆà¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™ 0%' : 'à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µ Activity (Lv.5)'
                          )
                        : null,

                      (tp.details||[]).map(d=>React.createElement("div",{key:d.id,style:{padding:12,border:"1px solid var(--border)",borderRadius:16,display:"flex",justifyContent:"space-between",gap:12,flexWrap:"wrap"}},
                        React.createElement("div",{style:{minWidth:0,flex:"1 1 200px"}},
                          React.createElement("div",{style:{display:"flex",gap:10,alignItems:"center",flexWrap:"wrap"}},
                            React.createElement(StatusBadge,{status:d.status}),
                            React.createElement("div",{style:{fontWeight:900},className:"ellipsis"},d.name)
                          ),
                          d.description ? React.createElement("div",{style:{marginTop:6,fontSize:12,fontWeight:800,color:"#475569"}}, "à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”: ", d.description) : null,
                          d.problem ? React.createElement("div",{style:{marginTop:6,fontSize:12,fontWeight:900,color:"#b91c1c"}}, "âš  à¸›à¸±à¸à¸«à¸²/à¸­à¸¸à¸›à¸ªà¸£à¸£à¸„: ", d.problem) : null,
                          React.createElement("div",{style:{marginTop:6,fontSize:12,fontWeight:900,color:"#64748b"}}, "KPI Weight: ", d.points, " pts")
                        ),
                        React.createElement("div",{style:{textAlign:"right",display:"flex",flexDirection:"column",gap:8,alignItems:"flex-end"}},
                          React.createElement("div",{style:{fontSize:22,fontWeight:900}}, clamp(d.progress)+"%"),
                          canEdit ? React.createElement("button",{className:"btnSoft",onClick:()=>openEditActivity(tp.id,d)},"âœŽ Edit / Update") : null
                        )
                      ))
                    )
                  ))
                )
              ))
            )
          )
        )
      );
    }

    function renderView(){
      if(view==="dashboard") return React.createElement(Dashboard);
      if(view==="explorer") return React.createElement(Explorer);
      if(view==="budget") return React.createElement(Budget);
      if(view==="reports") return React.createElement(Reports);
      return React.createElement("div",{className:"card"},"Unknown view");
    }

    // If not logged in, show login page
    if(!user){
      return React.createElement(LoginPage);
    }

    return React.createElement("div",{className:"app"},
      React.createElement("div",{className:"sidebarOverlay" + (sidebarOpen?" show":""),onClick:closeSidebar}),
      React.createElement(Sidebar),
      React.createElement("div",{className:"main"},
        React.createElement(Header),
        React.createElement("div",{className:"content",onClick:closeSidebar}, renderView()),
        React.createElement(ProjectFormModal),
        React.createElement(ProjectDetailModal),
        React.createElement(SimpleAddModal),
        React.createElement(ActivityModal)
      )
    );
  }

  const root = ReactDOM.createRoot(document.getElementById("root"));
  root.render(React.createElement(App));
  </script>
</body>
</html>
